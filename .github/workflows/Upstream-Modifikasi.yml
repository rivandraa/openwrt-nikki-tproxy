name: Sync Upstream Modifikasi

on:
  workflow_dispatch:

jobs:
  selective-sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout destination repo (this repo)
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Add upstream and fetch
        run: |
          git remote add upstream https://github.com/nikkinikki-org/OpenWrt-nikki.git
          git fetch upstream main

      - name: Get previous synced commit
        id: get_last_commit
        run: |
          if [ -f .last-upstream-commit ]; then
            LAST_COMMIT=$(cat .last-upstream-commit)
          else
            LAST_COMMIT=$(git rev-parse upstream/main~1)
          fi
          echo "last_commit=$LAST_COMMIT" >> $GITHUB_OUTPUT

      - name: Get latest upstream commit
        id: get_latest_commit
        run: |
          LATEST=$(git rev-parse upstream/main)
          echo "latest_commit=$LATEST" >> $GITHUB_OUTPUT

      - name: Determine changed files from upstream
        id: changed_files
        run: |
          CHANGED=$(git diff --name-only ${{ steps.get_last_commit.outputs.last_commit }} ${{ steps.get_latest_commit.outputs.latest_commit }} | grep -E '^(luci-app-nikki|nikki)/' || true)
          echo "$CHANGED" > changed_files.txt
          if [ -z "$CHANGED" ]; then
            echo "no_new_commit=true" >> $GITHUB_OUTPUT
          else
            echo "no_new_commit=false" >> $GITHUB_OUTPUT
          fi
          echo "changed=$(paste -sd ',' changed_files.txt)" >> $GITHUB_OUTPUT

      - name: Clone upstream repo for file copy
        if: steps.changed_files.outputs.no_new_commit == 'false'
        run: |
          git clone --depth=1 --branch=main https://github.com/nikkinikki-org/OpenWrt-nikki.git upstream-source

      - name: Merge and handle conflicts
        if: steps.changed_files.outputs.no_new_commit == 'false'
        run: |
          HAS_CONFLICTS="false"
          for file in $(cat changed_files.txt); do
            echo "üîÑ Processing file: $file"
            LOCAL="$file"
            REMOTE="upstream-source/$file"
            BASE=".git/tmp-base-$file"

            mkdir -p "$(dirname "$BASE")"
            mkdir -p "$(dirname "$LOCAL")"

            git show "${{ steps.get_last_commit.outputs.last_commit }}:$file" > "$BASE" 2>/dev/null || touch "$BASE"

            if [ -f "$REMOTE" ]; then
              if [ -f "$LOCAL" ]; then
                if ! git merge-file -p -L LOCAL -L BASE -L UPSTREAM "$LOCAL" "$BASE" "$REMOTE" > "$LOCAL.merged"; then
                  echo "‚ö†Ô∏è Konflik merge: $file"
                  HAS_CONFLICTS="true"
                fi
                if [ -s "$LOCAL.merged" ]; then
                  mv "$LOCAL.merged" "$LOCAL"
                  echo "‚úÖ Merge selesai: $file"
                else
                  rm -f "$LOCAL.merged"
                fi
              else
                cp -a "$REMOTE" "$LOCAL"
                echo "üì• Ambil file baru: $file"
              fi
            fi
          done
          echo "has_conflicts=$HAS_CONFLICTS" >> $GITHUB_OUTPUT

      - name: Update .last-upstream-commit
        if: steps.changed_files.outputs.no_new_commit == 'false'
        run: |
          echo "${{ steps.get_latest_commit.outputs.latest_commit }}" > .last-upstream-commit

      - name: Commit changes from upstream only
        if: steps.changed_files.outputs.no_new_commit == 'false'
        run: |
          git add .last-upstream-commit
          git add $(cat changed_files.txt) || true

          if ! git diff --cached --quiet; then
            if grep -qr '<<<<<<< LOCAL' luci-app-nikki nikki; then
              MSG="‚ö†Ô∏è Sync from upstream (ada konflik): ${{ steps.get_latest_commit.outputs.latest_commit }}"
            else
              MSG="Sync from upstream: ${{ steps.get_latest_commit.outputs.latest_commit }}"
            fi
            git commit -m "$MSG"
            git remote set-url origin https://x-access-token:${{ secrets.PAT_WORKFLOW }}@github.com/${{ github.repository }}.git
            git push origin mainrelease
          else
            echo "No changes to commit"
          fi

      - name: Notify to Telegram
        if: always()
        run: |
          REPO_URL="https://github.com/${{ github.repository }}"
          BRANCH="mainrelease"
          FILES=$(git diff-tree --no-commit-id --name-status -r HEAD | grep -E '^(A|M|D)\s+(luci-app-nikki|nikki)/' || true)

          if [ -n "$FILES" ]; then
            CHANGED=$(echo "$FILES" | while read status path; do
              case "$status" in
                A) ICON="üÜï" ;;
                M) ICON="‚úèÔ∏è" ;;
                D) ICON="‚ùå" ;;
                *) ICON="üìÑ" ;;
              esac

              ESCAPED_NAME=$(echo "$path" | sed -e 's/([][*()])/\\&/g')

              if grep -q '<<<<<<< LOCAL' "$path" 2>/dev/null; then
                CONFLICT_NOTE=" ‚ö†Ô∏è *File Konflik*"
              else
                CONFLICT_NOTE=""
              fi

              if [ "$status" = "D" ]; then
                echo "- $ICON $ESCAPED_NAME$CONFLICT_NOTE"
              else
                echo "- $ICON [$ESCAPED_NAME]($REPO_URL/blob/$BRANCH/$path)$CONFLICT_NOTE"
              fi
            done)
            MSG=$(printf "üõéÔ∏è *Sync dari upstream selesai*\n\n*File berubah:*\n%s" "$CHANGED")
          else
            MSG="üõéÔ∏è *Sync dari upstream selesai*\n\nTidak ada Update."
          fi

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$MSG" \
            -d parse_mode="Markdown"
